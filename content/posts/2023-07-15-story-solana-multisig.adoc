= Story of a Solana multisig signature
chalda <ondrej.chaloupka@proton.me>
1.0, 2023-07-25

:page-template: post
:page-draft: true
:page-slug: spl-governance-transaction
:page-category: solana
:page-tags: Solana, Typescript, SPL.Governance
:page-description: A story of developer creating a SPL Governance transaction
:page-socialImage:  /images/articles/spl-custom-transaction/spl-governance-story.jpg

image::articles/spl-custom-transaction/spl-governance-story.jpg[]

I want to share a story of an ordinal developer that gets a task and during the process he comes to learn various things
and details in different contexts. This story is about Solana multisig via SPL Governance
and creating a transaction that multisig signs and executes.

== SPL Governance as multisig manager

The https://github.com/solana-labs/solana-program-library/blob/master/governance/[SPL Governance] is a Solana program that runs DAO management.
One https://app.realms.today/realms[can create] his own DAO instance in the system and use the SPL Governance for community to manage the DAO.
But another good usage is to use it as multisig. For that one creates a new DAO where no community is involved and only particular wallets
has permission to proceed with signatures. A benefit of the https://twitter.com/realms_daos[SPL Governance] system is that's part of
the Solana Program Library and thus it's developed by people from https://solanalabs.com[Solana Labs].

This is simple as go to https://app.realms.today/ (when testing the setup at devnet add https://app.realms.today/?cluster=devnet[?cluster=devnet]),
click at blue button `Create DAO` and choose the `Multi-Signature Wallet`. The wizard goes with you through few steps
where one defines what wallet keys will be part of the multisig management (members of the multisig may be still
https://docs.realms.today/DAO-Management/DAO-add-members[added or removed later])
and then the multisig DAO is created.

NOTE: For technical details about the SPL Governance system I recommend to read through the
      https://docs.realms.today/spl-governance-deep-dive[SPL Governance Deep Dive] article.

For the purpose of the showcase in this blog post I have created a DAO
https://app.realms.today/dao/2EogxMvrtTr8ccA4oQcAGfS8vKbDhYTANA12LW3fqUy3?cluster=devnet[Solana multisig signature]
https://app.realms.today/dao/2EogxMvrtTr8ccA4oQcAGfS8vKbDhYTANA12LW3fqUy3/members?cluster=devnet[with one member]
of address FwkjePeCG5CjD8uYsHh3hvj6X26KnNh2UrpZSpDiNbfh.

image::articles/spl-custom-transaction/one-member.png[]

// TODO: could be possible to share the key?

Any action that the multisig signs have to be defined as a `Proposal` that contains transactions that are confirmed and may be executed
when enough multisig participants agree with.
At the main page of the DAO one click at `âŠ• New Proposal`. When the member wallet is connected a new `Proposal` can be created and then multisig owners
can vote for or against it. The SPL Governance system provides a list of `Instruction` types where one can send funds
or work with https://spl.solana.com/token[token accounts]. But what if my custom contract contains some admin abilities that I need to manage?
How can I create a transaction that contains an arbitrary data?

=== SPL Governance workflow

Before we talk about custom transactions for SPL Governance let's briefly discuss the `Proposal` workflow
in the SPL Governance system. The `Proposal` is a unit that represents "an action" to be processed.
The "action" is constituted as a transaction that can be executed when acknowledged by all multisig members.

The SPL Governance `Proposal` workflow is first to create a `Proposal` with one or several instructions.
Multisig members votes for the proposal. When the defined threshold of votes (acknowledgments) is exceeded then
the instruction that constitutes the `Proposal` can be executed. That transaction (a set of instructions) is signed
by the multisig address represented by `Governance Wallet`. This part is important from the perspective
of the multisig signature and administering a admin rights in a contract. It's the `Governance Wallet` address
that needs to be defined as the administrator. It's the `Governance Wallet` that signs the transactions on behalf
of the acknowledgment of the multisig members.

The workflow continues when all transactions are executed then `Proposal` can be finalized.
`Finalize` operation "parks" the `Proposal` to the final state for the SPL system recognizing it as a finished matter.

=== SPL Governance Custom Transaction

For anybody can create a `Proposal` with whatever transaction content there is Instruction type `Common: Execute Custom Instruction`.
The transaction can be created with UI for anybody having the keys for the council power
at the address of the DAO https://app.realms.today/dao/2EogxMvrtTr8ccA4oQcAGfS8vKbDhYTANA12LW3fqUy3/proposal/new?cluster=devnet

image::articles/spl-custom-transaction/custom-transaction-proposal.png[]

The field `Governance` defines the multisig signature key that the transaction will be signed with.
`Hold up time (days)` can be defined with 0 if we don't want to delayed the instruction execution after `Proposal` acknowledgment.
The `Instruction` field has to be filled with `Base64 encoded serialized Solana instruction`...

But wait, where to get it?

Basically, this can be whatever transaction that is encoded to `base64` of borsh(!) serialized data
that contains `program id`, `account keys` and `call data`

[source,typescript]
----
[
  InstructionData,
  {
    kind: 'struct',
    fields: [
      ['programId', 'pubkey'],
      ['accounts', [AccountMetaData]],
      ['data', ['u8']],
    ],
  }
]
----

When we work with Typescript we can use the https://github.com/solana-labs/oyster[Oyster] SPL Governance SDK
that provides the function
https://github.com/solana-labs/oyster/blob/040b7c89f757846f64c2436dbb58ecc4db8c5837/packages/governance-sdk/src/governance/serialisation.ts#L229[`serializeInstructionToBase64`]
that takes an instruction and provides the encoded form
that can be copy-pasted into the field.

If we work with Rust we need to transform the `Transaction` structure in the required format and print it.
When using `bincode` then one can use the way provided in Anchor CLI in function
https://github.com/coral-xyz/anchor/blob/v0.28.0/cli/src/lib.rs#L2247[print_idl_instruction]
(included as part of the PR https://github.com/coral-xyz/anchor/pull/2486/files#diff-c1f8f7498da827a634bddc8a7559198bc99b296e9d9e8b91a70b503662995b8cR2248[CLI anchor idl command to use dump base64 for set-buffer and close])
or in case of usage `serde` then prepare the `struct` that align with the expected format. It could be for example as of struct
https://github.com/marinade-finance/multisig/blob/master/programs/multisig/src/lib.rs#L239[TransactionInstruction]
that implements https://github.com/marinade-finance/multisig/blob/master/programs/multisig/src/lib.rs#L263[From for Instruction]
and can be used like https://github.com/coral-xyz/anchor/pull/2486/commits/ff4d9f9a1c4fb875b5ac0d772d99fa97d01b5208#diff-c1f8f7498da827a634bddc8a7559198bc99b296e9d9e8b91a70b503662995b8cR2068[base64::encode(ix.into().try_to_vec()?)]. 

== Contract example with admin authority

To show the deployment I use a simple example contract https://github.com/ochaloup/simple-admin/tree/v2[`Simple admin`]
under `v2` branch (the first version of the contract https://github.com/ochaloup/simple-admin/tree/v2[`v1`]
was used as example in the article link:./decoding-solana-data[Decoding Solana data accounts]).

The contract works on the simple base where admin has to sign the
https://github.com/ochaloup/simple-admin/blob/v2/programs/simple-admin/src/instructions/print_message.rs[`PrintMessage`]
instruction. When signed then instruction is successfully executed which prints message
into the transaction log and saves it into a separate solana account.
The created admin account https://explorer.solana.com/address/3oZa6pjVpC5m1gaKYnXWoxahrBQt2dCsapBSiDAMBWoh/anchor-account?cluster=devnet[`3oZa6pjVpC5m1gaKYnXWoxahrBQt2dCsapBSiDAMBWoh`] configures the admin being
the multisig governance wallet https://app.realms.today/dao/2EogxMvrtTr8ccA4oQcAGfS8vKbDhYTANA12LW3fqUy3/treasury/v2?cluster=devnet[`GjYBMcRv4JzkgqCfeUKQMs7KygkFvgLpGzFbQ7SihGJ8`].

With that the `PrintMessage` instruction has to be signed with SPL governance `Proposal` acknowledged by members of the multisig.
There is not such a `Proposal` type in the Governance UI and we need to provide the base64 encoded transaction.
The `simple-admin` contract provides a CLI command for that purpose.

[source,sh]
----
git clone https://github.com/ochaloup/simple-admin -b v2
cd simple-admin

pnpm install
# check content of the simple account
pnpm cli -ud show -a 3oZa6pjVpC5m1gaKYnXWoxahrBQt2dCsapBSiDAMBWoh
----

[source,json]
----
{
  programId: 'sa4ihCaRZKuYZtY4fcdnNqx9vx9Lc6KELrL2nBkzNn2',
  data: [
    {
      publicKey: '3oZa6pjVpC5m1gaKYnXWoxahrBQt2dCsapBSiDAMBWoh',
      admin: 'GjYBMcRv4JzkgqCfeUKQMs7KygkFvgLpGzFbQ7SihGJ8',
      printCallCount: '0',
      createdAccountNextIndex: 0
    }
  ]
}
----


[source,sh]
----
# trying to execute the print-message with default solana wallet
pnpm cli -ud print-message  --message 'gm gm' 3oZa6pjVpC5m1gaKYnXWoxahrBQt2dCsapBSiDAMBWoh
> [...] ERROR (377647): Admin CUuLjSEx7q3AB3sRGn3sMJBsSNTmULwowMGUh6NdsxQD is not an admin of simple account 3oZa6pjVpC5m1gaKYnXWoxahrBQt2dCsapBSiDAMBWoh > (admin is GjYBMcRv4JzkgqCfeUKQMs7KygkFvgLpGzFbQ7SihGJ8)

# get base64 transaction data to be used as custom transaction
pnpm cli -ud print-message --print-only --rent-payer GjYBMcRv4JzkgqCfeUKQMs7KygkFvgLpGzFbQ7SihGJ8 --admin GjYBMcRv4JzkgqCfeUKQMs7KygkFvgLpGzFbQ7SihGJ8 --message 'gm gm' 3oZa6pjVpC5m1gaKYnXWoxahrBQt2dCsapBSiDAMBWoh
> Instructions:
>   DPRtGY504O6TnBjrarIUv9xLcAC17A/DMHqwT2cgX78FAAAAKaTrO1Ty3tvwfW/rnwokf8rtF+EgRM3z1Nxd+oTUD5gAAenE85m/zh0eB1j8UHbJDkYK+b+mqI9psHckuV6lrgRtAQCYBSVJmeyBwE67H9wKHeiNwzR47QJ0XgYHJjS6rEJoJQAB6cTzmb/OHR4HWPxQdskORgr5v6aoj2mwdyS5XqWuBG0BAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAARAAAARg8IXY5SF1kFAAAAZ20gZ20=
> [...] INFO (377533): Message 'gm gm' successfully printed for account 3oZa6pjVpC5m1gaKYnXWoxahrBQt2dCsapBSiDAMBWoh
----

[source,sh]
----
pnpm cli -ud show --address 3oZa6pjVpC5m1gaKYnXWoxahrBQt2dCsapBSiDAMBWoh --print-address
----

[source,json]
----
{
  programId: 'sa4ihCaRZKuYZtY4fcdnNqx9vx9Lc6KELrL2nBkzNn2',
  data: [
    {
      publicKey: 'BERXDKKk7xmArJXHxDdb9rRqLdd7TRsGXJyh6tj9ZTit',
      simpleAccount: '3oZa6pjVpC5m1gaKYnXWoxahrBQt2dCsapBSiDAMBWoh',
      message: 'gm gm'
    }
  ]
}
----
