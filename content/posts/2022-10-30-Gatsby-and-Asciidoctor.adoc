= Gatsby and Asciidoctor
chalda <ondrej.chaloupka@proton.me>
1.0, 2022-10-30

:icons: font
:toc: macro

:page-template: post
:page-draft: false
:page-slug: gatsby-and-asciidoctor
:page-category: devops
:page-tags: Asciidoctor, Blog
:page-description: My journey through basics of Gatsby and how to make it working with Asciidoctor.
:page-socialImage:

== Prolog

This blog hasn't got any update for a long time. One of the reason was a trouble of the underalying
static page generation system. I've used the link:posts/hubpress-io-how-to-install[Hubpress.io]
that has been working nicely few years ago but the system was deprecated and stopped to work right.
I decided to switch to another system and it was https://www.gatsbyjs.com[Gatsby] that caught my interest.
I'm not a frontend developer and I don't plan to learn https://reactjs.org[React] in details
but I wanted to check some basics.

I started with searching https://jamstackthemes.dev/ssg/gatsby/[the Gatsby themes] and looking for a blog one.
I wanted one that supports link:posts/asciidoctor[Asciidoctor]
but 99.9% of themes work only with the https://daringfireball.net/projects/markdown/syntax[Markdown].
The rest in the 0.1% are rather showcases than themes.
I decided for https://github.com/alxshelepenok/gatsby-starter-lumen[Gatsby Starter Lumen]
and for adjusting it to work with Asciidoctor.

== Learning Gatsby

When I decided for adjustments I found I need to understand the structure of the Gatsby project much better.
After reading few getting started posts I found the best was to go through was this tutorial
https://www.freecodecamp.org/news/build-a-developer-blog-from-scratch-with-gatsby-and-mdx[How to Build Your Coding Blog From Scratch Using Gatsby and MDX].
It's a little older and not all details work perfectly
but it is a really great way to understand the structure.
It elaborates on details of content processing, graphql queries, styling and others things.

=== Changing Markdown for Asciidoctor

One thing that I understood quite soon was that the tutorial uses the
https://www.gatsbyjs.com/plugins/gatsby-plugin-mdx[gatsby-plugin-mdx].
While the _Gatsby Starter Lumen_ works with with
https://www.gatsbyjs.com/plugins/gatsby-transformer-remark[gatsby-transformer-remark].
I.e., there are different Markdown plugins of the same prupose in the ecosystem.

The "good news" is that there is only one Asciidoctor plugin available as
https://www.gatsbyjs.com/plugins/gatsby-transformer-asciidoc[gatsby-transformer-asciidoc].
The fine thing is that the `gatsby-transformer-asciidoc`
is pretty similar to `gatsby-transformer-remark` which one that's used in _Lumen Starter_ project.

My goal when working with tutorial was to learn how to use `.adoc` in parallel with `.md`.

The repository that contains the changes is at https://github.com/ochaloup/gatsby-from-scratch

NOTE: I haven't finished whole tutorial as I wrapped it up in middle of the text when MDX plugin stopped
      to work for me. Later I found it's because
      of https://github.com/gatsbyjs/gatsby/discussions/34714#discussioncomment-2108962[some Gatsby changes].


image::articles/gatsby-font-line.jpg["A decorator line"]

=== Gatsby structure

Let's briefly recap about the Gatsby project structure.

==== A JavaScript project

As non-javascript developer I needed to start with few things around the JS project.

* dependencies are defined in `package.json`
* multiple package managers exists - default `npm`, better `yarn`, newer a and faster `pnpm`
  (`yarn` sounds good to be used)
* `yarn install` downloads `js` dependencies and places them under `$PWD/node_modules`
* when dependencies are installed a `lock` files (`yarn.lock`, `package-lock.json`) are created.
  They ensures the same versions of the libraries are used when building subsequently on other environments.
  They are https://stackoverflow.com/questions/44552348/should-i-commit-yarn-lock-and-package-lock-json-files[recommended to be pushed to github].
* when working with TypeScript the configuration file is `tsconfig.json`. It configures how the transpiler
  built the final `js` file.
* `package.json` contains section `"scripts"` that defines automation of different commands.
  Any defined `script` command may be executed with `npm run <command>` or `yarn <command>`.

==== A Gatsby project

Now what I learnt about the Gatsby itself.

image::articles/gatsby-font-title.jpg["Illustrative image of art deco Gatsby font"]

* The configuration file is `gatsby-config.[js,ts]`. It defines global properties and configures gatsby plugins
  where the plugin needs to be defined as dependency in `package.json` as well.
* The configuration file `gatsby-node.js` defines hooks that are executed on startup of nodejs.
  It's a way to setup dynamic pages where we want to list a set of options, like categories or tags are.
* The `gatsby-browser.js` sets up the behaviour for browsers (e.g. SCSS files).
* The `content/config.js` is used by _Lumen theme_ to get some basic config of site (e.g., title).

Then we have a directory structure explained better
https://www.gatsbyjs.com/docs/reference/gatsby-project-structure/[at the Gatsby documentation].
But quick view on what I needed.

The Gatsby is a React application thus the directory structure consists of _Gatsby specific parts_
and the directories _comming from React_.

* `public/` is automatically generated and contains output of the build process (part of `.gitignore`)
* `static/` contains data that are copied to `public/` as they are, may contain images for example
* `content/` is not standard Gatsby directory but it's usually configured in
   https://github.com/alxshelepenok/gatsby-starter-lumen/blob/3a6dbc17ca00ad4ccc84e82a840b59c3824ab709/gatsby-config.ts#L20[`gatsby-config`]
   and contains Mardown or Asciidoctor sources, later processed by particular plugins
* `src/` directory contains all code
** `src/pages/` happens to be generated as a page directly based on the path (e.g., `index.js` could be created)
** `src/templates` templates used in programatically build pages
** `src/compontents` react directory, contains react components that can be used within `templates`
** `src/hooks/` react directory, hooks that can be invoked from components retrieving data, &hellip;
** `src/utils/` react directory, utilities
** `src/types/` react directory, for typescript types definitions

The best is to click through https://github.com/alxshelepenok/gatsby-starter-lumen/[the Lumen Starter directory structure]
or https://github.com/spences10/thelocalhost/tree/blog-post-code[the tutorial project].
It may not contain or have some additional directories to what mentioned but it sheds light on this part.

image::articles/gatsby-font-line.jpg["A decorator line", height=30]

The gatsby provides command line tool `gatsby` to generate the content (`gatsby build`)
and to help with development (`gatsby develop`).
If it's installed with `yarn` we could have configured
https://github.com/ochaloup/gatsby-from-scratch/blob/main/hello-world/package.json#L8[the `script`]
that works from `node_modules`.

The Lumen can be started at localhost dev mode with `yarn start`. Then the side can be accessed at http://localhost:8000
and graphql at http://localhost:8000/___graphql (all that info shown at console during startup).

=== Gatsby GraphQL

All data that Gatsby works with comes through the GraphQL (processing comes from React).
The Markdown and Asciidoctor plugins processes the documents
where the results can be consumed by GraphQL queries. All components then loads stuff
information like title, tags and generated HTML and places it based on the visual demands to particular places.

The most of the work for moving from Markdown to Asciidoctor was a need to map the Markdown based GraphQL query
that's part of the Lumen Starter and change it for Asciidoctor.

My work with tutorial tried to work with `adoc` and `md` data (MDX plugin is used) side by side.
You can see e.g., here https://github.com/ochaloup/gatsby-from-scratch/blob/main/hello-world/src/pages/index.js#L40

[source,graphql]
----
query SITE_INDEX_QUERY {
  allMdx(
    sort: { fields: [frontmatter___date], order: DESC }
    filter: { frontmatter: { published: { eq: true } } }
  ) {
    nodes {
      id
      excerpt(pruneLength: 250)
      frontmatter {
        title
        date
      }
      fields {
        slug
      }
    }
  }
  allAsciidoc(
    sort: { fields: [revision___date], order: DESC }
    filter: { pageAttributes: { published: { eq: "true" } } }
  ) {
    nodes {
      id
      document {
        title
      }
      pageAttributes {
        synopsis
      }
      revision {
        date
      }
      fields {
        slug
      }
    }
  }
}
----

That query could be investigated in GraphQL console (http://localhost:8000/___graphql)
when running in developer mode.
The data generated by both plugins are structured in a bit different form
that comes for example from fact that Asciidoctor works with a pre-defined
https://docs.asciidoctor.org/asciidoc/latest/document/header/[header metadata]
while Markdown with no specific spec here.

Both plugins found data under `nodes` where the `node` represents one `md`/`adoc` document.
